---
import Layout from "../layouts/Layout.astro";
import AuthLayout from "../components/auth/AuthLayout.astro";
import AuthHeader from "../components/auth/AuthHeader.astro";
import Input from "../components/ui/Input.astro";
import PasswordInput from "../components/ui/PasswordInput.astro";
import Button from "../components/ui/Button.astro";
import Divider from "../components/ui/Divider.astro";
import GoogleButton from "../components/ui/GoogleButton.astro";

import loginHero from "../assets/img/login-hero.jpg";
---

<Layout title="Iniciar Sesión | Juega Demonio" showSocialLinks={false}>
  <AuthLayout
    heroImage={loginHero}
    heroAlt="Iniciar Sesión Juega Demonio"
    heroTitle="¿Aún no tienes cuenta Demonio?"
    heroButtonText="REGÍSTRATE"
    heroButtonHref="/registro"
    heroButtonVariant="primary"
  >
    <AuthHeader
      title="¡HOLA NUEVAMENTE!"
      linkLabel="¿Aún no tienes cuenta?"
      linkText="Suscríbete"
      linkHref="/registro"
    />

    <p class="text-intense-pink font-semibold text-sm mb-6">Inicia Sesión</p>

    <form id="login-form" class="space-y-5">
      <Input
        label="Correo"
        type="email"
        name="email"
        placeholder="Ingresa tu Correo"
        required
      />

      <PasswordInput
        label="Contraseña"
        name="password"
        placeholder="Ingresa tu contraseña"
        required
      />

      <div class="text-right">
        <a
          href="/recuperar-contrasena"
          class="text-xs text-charcoal hover:text-soft-pink transition-colors"
        >
          No recuerdo mi contraseña
        </a>
      </div>

      <div class="pt-2 flex justify-center">
        <Button type="submit" label="INICIAR SESIÓN" />
      </div>
    </form>

    <Divider text="O continúa con" />

    <div class="flex justify-center">
      <GoogleButton />
    </div>
  </AuthLayout>
</Layout>

<script>
  import axios from "axios";

  const API_BASE_URL = import.meta.env.PUBLIC_API_URL || "/api";

  function initLoginForm() {
    const form = document.getElementById("login-form") as HTMLFormElement;

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const email = formData.get("email") as string;
      const password = formData.get("password") as string;
      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "INICIANDO...";
      }

      try {
        const response = await axios.post(`${API_BASE_URL}/auth/login`, { email, password });
        const { accessToken, refreshToken, user } = response.data;

        localStorage.setItem("accessToken", accessToken);
        localStorage.setItem("refreshToken", refreshToken);
        localStorage.setItem("cachedUser", JSON.stringify(user));
        localStorage.setItem("authCheckedAt", String(Date.now()));

        window.location.href = "/app/dashboard";
      } catch (err: any) {
        const message = err.response?.data?.message || "Error al iniciar sesión";
        let errorEl = form.querySelector(".login-error") as HTMLElement;
        if (!errorEl) {
          errorEl = document.createElement("p");
          errorEl.className = "login-error text-red-500 text-sm text-center";
          form.prepend(errorEl);
        }
        errorEl.textContent = message;
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "INICIAR SESIÓN";
        }
      }
    });
  }

  initLoginForm();
  document.addEventListener("astro:after-swap", initLoginForm);
</script>
