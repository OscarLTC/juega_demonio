---
import { cn } from "../../utils/cn";
import { Icon } from "astro-icon/components";

interface Props extends astroHTML.JSX.InputHTMLAttributes {
  label?: string;
  error?: string;
}

const { label, error, class: className, id, ...rest } = Astro.props;

const inputId = id || rest.name || "password";
const toggleId = `toggle-${inputId}`;
const iconEyeId = `icon-eye-${inputId}`;
const iconEyeOffId = `icon-eye-off-${inputId}`;
---

<div class="w-full">
  {label && (
    <label for={inputId} class="block text-soft-pink text-sm font-medium mb-2">
      {label}
    </label>
  )}
  <div class="relative">
    <input
      type="password"
      id={inputId}
      class={cn(
        "w-full bg-secondary border border-soft-pink rounded-full px-6 py-3 pr-12",
        "text-white placeholder-charcoal",
        "focus:border-intense-pink focus:outline-none transition-colors",
        className
      )}
      {...rest}
    />
    <button
      type="button"
      data-toggle-password={inputId}
      class="absolute right-4 top-1/2 -translate-y-1/2 text-charcoal hover:text-light-gray transition-colors"
    >
      <Icon data-icon-eye={inputId} name="ion:eye-outline" class="w-5 h-5" />
      <Icon data-icon-eye-off={inputId} name="ion:eye-off-outline" class="w-5 h-5 hidden" />
    </button>
  </div>
  {error && (
    <p data-password-error={inputId} class="text-xs text-red-500 mt-2 hidden">{error}</p>
  )}
</div>

<script>
  function initPasswordToggles() {
    document.querySelectorAll<HTMLButtonElement>('[data-toggle-password]').forEach(button => {
      const inputId = button.dataset.togglePassword;
      const input = document.getElementById(inputId!) as HTMLInputElement;
      const iconEye = button.querySelector(`[data-icon-eye="${inputId}"]`);
      const iconEyeOff = button.querySelector(`[data-icon-eye-off="${inputId}"]`);

      button.addEventListener('click', () => {
        const type = input.type === 'password' ? 'text' : 'password';
        input.type = type;
        iconEye?.classList.toggle('hidden');
        iconEyeOff?.classList.toggle('hidden');
      });
    });
  }

  initPasswordToggles();
  document.addEventListener('astro:after-swap', initPasswordToggles);
</script>
